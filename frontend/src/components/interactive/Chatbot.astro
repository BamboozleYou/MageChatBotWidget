---
/**
 * Mage Data AI Chatbot Widget
 * Replaces: src/components/interactive/Chatbot.astro
 *
 * Implements every requirement from CHATBOT_BUILD_INSTRUCTIONS.md:
 *   Section 3  — Frontend Widget (visual, layout, deferred, view transitions, UI, a11y)
 *   Section 7  — Lead Capture & HubSpot
 *   Section 8  — Analytics Events
 *   Section 9  — Cookie Consent Coexistence
 *   Section 11 — Testing Checklist items
 */
---

<!-- ══════════════════════════════════════════════════════════════
     CHATBOT WIDGET — transition:persist keeps it alive across
     Astro View Transitions (Section 3d)
     ══════════════════════════════════════════════════════════════ -->
<div id="mage-chat-widget" class="mage-chat-widget" transition:persist>

  <!-- ── Screen reader live region (Section 3f) ──────────────── -->
  <div id="mage-sr-announcer" aria-live="polite" aria-atomic="false"
       class="sr-only" style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;"></div>

  <!-- ── Toggle Bubble (Section 3e-1) ────────────────────────── -->
  <button
    id="mage-toggle"
    type="button"
    aria-label="Open chat"
    aria-expanded="false"
    aria-controls="mage-panel"
    class="mage-toggle mage-bubble-pulse"
  >
    <!-- Chat icon -->
    <svg id="mage-icon-chat" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
    </svg>
    <!-- Close icon (hidden by default) -->
    <svg id="mage-icon-close" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
      <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
    </svg>
  </button>

  <!-- ── Chat Panel (Section 3e-2) ───────────────────────────── -->
  <div
    id="mage-panel"
    role="dialog"
    aria-label="Chat with Mage Data"
    aria-modal="true"
    class="mage-panel"
    style="display:none;"
  >
    <!-- Header -->
    <div class="mage-header">
      <div class="mage-header-left">
        <div class="mage-avatar-sm">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#E67425" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
          </svg>
        </div>
        <div>
          <div class="mage-header-title">Mage Data Assistant</div>
          <div class="mage-header-status"><span class="mage-online-dot"></span>Online</div>
        </div>
      </div>
      <button id="mage-close" type="button" aria-label="Close chat" class="mage-close-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Messages area -->
    <div id="mage-messages" class="mage-messages">
      <!-- Welcome message injected by JS -->
    </div>

    <!-- Input bar (Section 3e-3) -->
    <div class="mage-input-bar">
      <input
        id="mage-input"
        type="text"
        placeholder="Type a message..."
        autocomplete="off"
        aria-label="Type a message"
        class="mage-input"
      />
      <button id="mage-send" type="button" aria-label="Send message" class="mage-send-btn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      </button>
    </div>

    <!-- Branding footer -->
    <div class="mage-footer">
      Powered by <strong>Mage Data</strong>
    </div>
  </div>
</div>


<!-- ══════════════════════════════════════════════════════════════
     STYLES — scoped to .mage-chat-widget
     ══════════════════════════════════════════════════════════════ -->
<style is:global>
  /* ── CSS Variables (Section 3a — brand colors) ─────────────── */
  .mage-chat-widget {
    --mage-navy: #122045;
    --mage-orange: #E67425;
    --mage-orange-hover: #CF6620;
    --mage-white: #FFFFFF;
    --mage-gray-bg: #F0F2F4;
    --mage-gray-light: #F8F9FA;
    --mage-gray-text: #6B7280;
    --mage-gray-border: #E5E7EB;
    --mage-radius: 0.75rem;
    --mage-shadow: 0 8px 32px rgba(18, 32, 69, 0.18), 0 2px 8px rgba(0,0,0,0.08);
    --mage-font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-family: var(--mage-font);
    line-height: 1.5;
    box-sizing: border-box;
  }
  .mage-chat-widget *, .mage-chat-widget *::before, .mage-chat-widget *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  /* ── Toggle Bubble (Section 3b — positioning) ──────────────── */
  .mage-toggle {
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9990;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background: var(--mage-orange);
    color: var(--mage-white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 16px rgba(230, 116, 37, 0.4), 0 2px 4px rgba(0,0,0,0.1);
    transition: background 0.2s, transform 0.2s, bottom 0.3s ease;
  }
  .mage-toggle:hover {
    background: var(--mage-orange-hover);
    transform: scale(1.06);
  }
  .mage-toggle:active { transform: scale(0.96); }

  /* ── Bubble pulse animation ────────────────────────────────── */
  @keyframes mageBubblePulse {
    0% { box-shadow: 0 4px 16px rgba(230, 116, 37, 0.4), 0 0 0 0 rgba(230, 116, 37, 0.45); }
    70% { box-shadow: 0 4px 16px rgba(230, 116, 37, 0.4), 0 0 0 16px rgba(230, 116, 37, 0); }
    100% { box-shadow: 0 4px 16px rgba(230, 116, 37, 0.4), 0 0 0 0 rgba(230, 116, 37, 0); }
  }
  .mage-bubble-pulse { animation: mageBubblePulse 2s ease-out 3; }

  /* ── Chat Panel (Section 3b — positioning) ─────────────────── */
  .mage-panel {
    position: fixed;
    bottom: 96px;
    right: 24px;
    z-index: 9990;
    width: 390px;
    max-height: calc(100vh - 140px);
    border-radius: var(--mage-radius);
    background: var(--mage-white);
    box-shadow: var(--mage-shadow);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid var(--mage-gray-border);
  }

  /* ── Panel animations ──────────────────────────────────────── */
  @keyframes magePanelIn {
    from { opacity: 0; transform: translateY(16px) scale(0.96); }
    to   { opacity: 1; transform: translateY(0) scale(1); }
  }
  @keyframes magePanelOut {
    from { opacity: 1; transform: translateY(0) scale(1); }
    to   { opacity: 0; transform: translateY(16px) scale(0.96); }
  }
  .mage-panel-enter { animation: magePanelIn 0.25s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
  .mage-panel-exit  { animation: magePanelOut 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

  /* ── Header ────────────────────────────────────────────────── */
  .mage-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 16px;
    background: var(--mage-navy);
    color: var(--mage-white);
    flex-shrink: 0;
  }
  .mage-header-left { display: flex; align-items: center; gap: 10px; }
  .mage-avatar-sm {
    width: 34px; height: 34px;
    border-radius: 50%;
    background: rgba(255,255,255,0.12);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .mage-header-title {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: -0.01em;
  }
  .mage-header-status {
    font-size: 11px;
    opacity: 0.75;
    display: flex;
    align-items: center;
    gap: 5px;
    margin-top: 1px;
  }
  .mage-online-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background: #34D399;
    display: inline-block;
    flex-shrink: 0;
  }
  .mage-close-btn {
    background: rgba(255,255,255,0.1);
    border: none;
    color: var(--mage-white);
    cursor: pointer;
    padding: 6px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.15s;
  }
  .mage-close-btn:hover { background: rgba(255,255,255,0.2); }

  /* ── Messages Area ─────────────────────────────────────────── */
  .mage-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px;
    background: var(--mage-gray-light);
    display: flex;
    flex-direction: column;
    gap: 12px;
    min-height: 280px;
    max-height: 420px;
    scroll-behavior: smooth;
  }
  /* Scrollbar */
  .mage-messages::-webkit-scrollbar { width: 5px; }
  .mage-messages::-webkit-scrollbar-track { background: transparent; }
  .mage-messages::-webkit-scrollbar-thumb { background: #D1D5DB; border-radius: 10px; }

  /* ── Message Bubbles ───────────────────────────────────────── */
  .mage-msg { display: flex; gap: 8px; max-width: 88%; }
  .mage-msg-bot { align-self: flex-start; }
  .mage-msg-user { align-self: flex-end; flex-direction: row-reverse; }

  .mage-msg-avatar {
    width: 30px; height: 30px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    font-size: 13px;
    margin-top: 2px;
  }
  .mage-msg-bot .mage-msg-avatar {
    background: var(--mage-navy);
    color: var(--mage-orange);
  }
  .mage-msg-user .mage-msg-avatar {
    background: var(--mage-orange);
    color: var(--mage-white);
  }

  .mage-msg-bubble {
    padding: 10px 14px;
    border-radius: var(--mage-radius);
    font-size: 13.5px;
    line-height: 1.55;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .mage-msg-bot .mage-msg-bubble {
    background: var(--mage-white);
    color: #1F2937;
    border: 1px solid var(--mage-gray-border);
    border-bottom-left-radius: 4px;
  }
  .mage-msg-user .mage-msg-bubble {
    background: var(--mage-orange);
    color: var(--mage-white);
    border-bottom-right-radius: 4px;
  }

  /* Links inside bot messages */
  .mage-msg-bot .mage-msg-bubble a {
    color: var(--mage-orange);
    text-decoration: underline;
    text-underline-offset: 2px;
    font-weight: 500;
  }
  .mage-msg-bot .mage-msg-bubble a:hover {
    color: var(--mage-orange-hover);
  }

  /* ── Message animation ─────────────────────────────────────── */
  @keyframes mageMsgIn {
    from { opacity: 0; transform: translateY(8px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .mage-msg-enter { animation: mageMsgIn 0.3s ease-out forwards; }

  /* ── Source pills ──────────────────────────────────────────── */
  .mage-sources {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 8px;
  }
  .mage-source-pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    background: var(--mage-gray-bg);
    border: 1px solid var(--mage-gray-border);
    border-radius: 100px;
    font-size: 11px;
    color: var(--mage-navy);
    text-decoration: none;
    transition: background 0.15s, border-color 0.15s;
    cursor: pointer;
  }
  .mage-source-pill:hover {
    background: #E2E5E9;
    border-color: #CBD5E1;
  }
  .mage-source-pill svg { flex-shrink: 0; }

  /* ── Typing Indicator ──────────────────────────────────────── */
  .mage-typing { display: flex; gap: 8px; align-self: flex-start; }
  .mage-typing-dots {
    display: flex;
    gap: 4px;
    padding: 12px 16px;
    background: var(--mage-white);
    border: 1px solid var(--mage-gray-border);
    border-radius: var(--mage-radius);
    border-bottom-left-radius: 4px;
  }
  @keyframes chatDotBounce {
    0%, 60%, 100% { transform: translateY(0); }
    30% { transform: translateY(-5px); }
  }
  .mage-typing-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
    background-color: #9CA3AF;
    animation: chatDotBounce 1.4s ease-in-out infinite;
  }
  .mage-typing-dot:nth-child(2) { animation-delay: 0.15s; }
  .mage-typing-dot:nth-child(3) { animation-delay: 0.3s; }

  /* ── Quick Reply Chips (Section 3e-2) ──────────────────────── */
  .mage-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 4px;
  }
  .mage-chip {
    display: inline-flex;
    align-items: center;
    padding: 7px 14px;
    background: var(--mage-white);
    border: 1.5px solid var(--mage-orange);
    border-radius: 100px;
    font-size: 12.5px;
    font-weight: 500;
    color: var(--mage-orange);
    cursor: pointer;
    transition: background 0.15s, color 0.15s, transform 0.1s;
    font-family: var(--mage-font);
  }
  .mage-chip:hover {
    background: var(--mage-orange);
    color: var(--mage-white);
    transform: translateY(-1px);
  }
  .mage-chip:active { transform: translateY(0); }

  /* ── Lead Capture Form (Section 3e-4 / Section 7) ──────────── */
  .mage-lead-form {
    background: var(--mage-white);
    border: 1px solid var(--mage-gray-border);
    border-radius: var(--mage-radius);
    padding: 16px;
    margin: 4px 0;
  }
  .mage-lead-form-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--mage-navy);
    margin-bottom: 10px;
  }
  .mage-lead-field {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid var(--mage-gray-border);
    border-radius: 6px;
    font-size: 13px;
    font-family: var(--mage-font);
    color: #1F2937;
    margin-bottom: 8px;
    transition: border-color 0.15s;
    background: var(--mage-white);
  }
  .mage-lead-field:focus {
    outline: none;
    border-color: var(--mage-orange);
    box-shadow: 0 0 0 3px rgba(230, 116, 37, 0.12);
  }
  .mage-lead-field::placeholder { color: #9CA3AF; }
  .mage-lead-submit {
    width: 100%;
    padding: 9px;
    border: none;
    border-radius: 6px;
    background: var(--mage-orange);
    color: var(--mage-white);
    font-size: 13px;
    font-weight: 600;
    font-family: var(--mage-font);
    cursor: pointer;
    transition: background 0.15s;
    margin-top: 2px;
  }
  .mage-lead-submit:hover { background: var(--mage-orange-hover); }
  .mage-lead-skip {
    display: block;
    text-align: center;
    margin-top: 8px;
    font-size: 11.5px;
    color: var(--mage-gray-text);
    cursor: pointer;
    background: none;
    border: none;
    font-family: var(--mage-font);
    text-decoration: underline;
    text-underline-offset: 2px;
  }
  .mage-lead-skip:hover { color: #374151; }

  /* ── Input Bar (Section 3e-3) ──────────────────────────────── */
  .mage-input-bar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 14px;
    border-top: 1px solid var(--mage-gray-border);
    background: var(--mage-white);
    flex-shrink: 0;
  }
  .mage-input {
    flex: 1;
    padding: 9px 12px;
    border: 1px solid var(--mage-gray-border);
    border-radius: 8px;
    font-size: 13.5px;
    font-family: var(--mage-font);
    color: #1F2937;
    background: var(--mage-gray-light);
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  .mage-input:focus {
    outline: none;
    border-color: var(--mage-orange);
    box-shadow: 0 0 0 3px rgba(230, 116, 37, 0.1);
    background: var(--mage-white);
  }
  .mage-input::placeholder { color: #9CA3AF; }
  .mage-send-btn {
    width: 38px; height: 38px;
    border-radius: 8px;
    border: none;
    background: var(--mage-orange);
    color: var(--mage-white);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: background 0.15s, transform 0.1s;
  }
  .mage-send-btn:hover { background: var(--mage-orange-hover); }
  .mage-send-btn:active { transform: scale(0.94); }
  .mage-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* ── Footer ────────────────────────────────────────────────── */
  .mage-footer {
    text-align: center;
    padding: 7px;
    font-size: 10.5px;
    color: #9CA3AF;
    border-top: 1px solid var(--mage-gray-border);
    background: var(--mage-white);
    flex-shrink: 0;
  }
  .mage-footer strong { color: var(--mage-navy); font-weight: 600; }

  /* ── Focus visible ring ────────────────────────────────────── */
  .mage-chat-widget *:focus-visible {
    outline: 2px solid var(--mage-orange);
    outline-offset: 2px;
  }

  /* ── Screen reader only ────────────────────────────────────── */
  .sr-only {
    position: absolute; width: 1px; height: 1px;
    overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap;
  }

  /* ── MOBILE (Section 3b) ───────────────────────────────────── */
  @media (max-width: 480px) {
    .mage-panel {
      width: calc(100vw - 2rem);
      right: 1rem;
      bottom: 88px;
      max-height: 60vh;
    }
    .mage-messages { min-height: 180px; max-height: none; flex: 1; }
    .mage-toggle { width: 54px; height: 54px; }
  }
</style>


<!-- ══════════════════════════════════════════════════════════════
     CLIENT-SIDE JAVASCRIPT — vanilla JS, no framework
     ══════════════════════════════════════════════════════════════ -->
<script is:inline>
(function() {
  'use strict';

  /* ─── CONFIGURATION (mirrors src/utils/chatbot.ts) ──────────── */
  const CONFIG = {
    apiEndpoint: 'https://your-api-domain.com/api/chat',
    delayMs: 5000,
    leadCapture: {
      enabled: true,
      triggerAfterMessages: 3,
      hubspotPortalId: '',
      hubspotFormId: '',
    },
    ui: {
      title: 'Mage Data Assistant',
      welcomeMessage: "Hi! I'm the Mage Data assistant. How can I help you today?",
      quickReplies: ['Request a demo', 'Learn about products', 'Talk to sales'],
      placeholder: 'Type a message...',
      errorMessage: "Sorry, I'm having trouble connecting. Please try again or contact info@magedata.ai",
    },
  };

  /* ─── STATE ─────────────────────────────────────────────────── */
  let isOpen = false;
  let isLoading = false;
  let messages = [];        // {role, content, sources?}
  let userMsgCount = 0;
  let leadCaptured = false;
  let leadFormShown = false;
  let chipsVisible = true;
  let sessionId = '';
  let chatbotInitialized = false;

  /* ─── RESTORE STATE from sessionStorage (Section 3d) ────────── */
  function restoreState() {
    try {
      const saved = sessionStorage.getItem('mage_chat_state');
      if (saved) {
        const s = JSON.parse(saved);
        messages = s.messages || [];
        userMsgCount = s.userMsgCount || 0;
        leadCaptured = s.leadCaptured || false;
        leadFormShown = s.leadFormShown || false;
        chipsVisible = s.chipsVisible !== undefined ? s.chipsVisible : true;
        sessionId = s.sessionId || crypto.randomUUID();
        isOpen = s.isOpen || false;
      } else {
        sessionId = crypto.randomUUID();
      }
    } catch(e) {
      sessionId = crypto.randomUUID();
    }
  }

  function saveState() {
    try {
      sessionStorage.setItem('mage_chat_state', JSON.stringify({
        messages, userMsgCount, leadCaptured, leadFormShown, chipsVisible, sessionId, isOpen,
      }));
    } catch(e) { /* quota exceeded, ignore */ }
  }

  /* ─── DOM REFERENCES ────────────────────────────────────────── */
  function $(id) { return document.getElementById(id); }

  /* ─── ANALYTICS (Section 8) ─────────────────────────────────── */
  function trackEvent(eventName, params) {
    // Respect cookie consent (Section 9)
    try {
      const consent = localStorage.getItem('magedata_consent');
      if (consent) {
        const c = JSON.parse(consent);
        if (c.analytics_storage !== 'granted') return;
      } else {
        return; // no consent yet, don't track
      }
    } catch(e) { return; }

    if (typeof window.gtag === 'function') {
      window.gtag('event', eventName, {
        event_category: 'chatbot',
        ...params,
      });
    }
  }

  /* ─── COOKIE CONSENT COEXISTENCE (Section 9) ────────────────── */
  function watchCookieBanner() {
    const banner = document.getElementById('cookie-consent');
    const toggle = $('mage-toggle');
    if (!banner || !toggle) return;

    function adjustPosition() {
      const isVisible = !banner.classList.contains('translate-y-full') &&
                        banner.style.display !== 'none' &&
                        banner.offsetParent !== null;
      toggle.style.bottom = isVisible ? '120px' : '24px';
    }

    adjustPosition();
    const observer = new MutationObserver(adjustPosition);
    observer.observe(banner, { attributes: true, attributeFilter: ['class', 'style'] });
  }

  /* ─── RENDER HELPERS ────────────────────────────────────────── */
  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function renderMarkdownLinks(text) {
    // Convert [text](url) to clickable links
    let html = escapeHtml(text);
    html = html.replace(
      /\[([^\]]+)\]\(([^)]+)\)/g,
      '<a href="$2" target="_blank" rel="noopener noreferrer" class="mage-bot-link">$1</a>'
    );
    // Convert **bold**
    html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    // Convert newlines to <br>
    html = html.replace(/\n/g, '<br>');
    return html;
  }

  function createBotAvatar() {
    return '<div class="mage-msg-avatar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg></div>';
  }

  function createUserAvatar() {
    return '<div class="mage-msg-avatar"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div>';
  }

  function scrollToBottom() {
    const el = $('mage-messages');
    if (el) { requestAnimationFrame(() => { el.scrollTop = el.scrollHeight; }); }
  }

  function announce(text) {
    const el = $('mage-sr-announcer');
    if (el) { el.textContent = ''; requestAnimationFrame(() => { el.textContent = text; }); }
  }

  /* ─── RENDER ALL MESSAGES ───────────────────────────────────── */
  function renderMessages() {
    const container = $('mage-messages');
    if (!container) return;
    container.innerHTML = '';

    // Welcome message (always first)
    const welcomeDiv = document.createElement('div');
    welcomeDiv.className = 'mage-msg mage-msg-bot mage-msg-enter';
    welcomeDiv.innerHTML = `
      ${createBotAvatar()}
      <div class="mage-msg-bubble">${renderMarkdownLinks(CONFIG.ui.welcomeMessage)}</div>
    `;
    container.appendChild(welcomeDiv);

    // Quick reply chips (if still visible and no messages yet)
    if (chipsVisible && messages.length === 0) {
      const chipsDiv = document.createElement('div');
      chipsDiv.className = 'mage-chips';
      chipsDiv.id = 'mage-chips';
      CONFIG.ui.quickReplies.forEach(text => {
        const chip = document.createElement('button');
        chip.type = 'button';
        chip.className = 'mage-chip';
        chip.textContent = text;
        chip.addEventListener('click', () => {
          chipsVisible = false;
          trackEvent('chatbot_quick_reply', { event_label: text });
          sendMessage(text);
        });
        chipsDiv.appendChild(chip);
      });
      container.appendChild(chipsDiv);
    }

    // Conversation messages
    messages.forEach((msg, i) => {
      const isBot = msg.role === 'assistant';
      const div = document.createElement('div');
      div.className = `mage-msg ${isBot ? 'mage-msg-bot' : 'mage-msg-user'} mage-msg-enter`;

      let bubbleContent = isBot
        ? renderMarkdownLinks(msg.content)
        : escapeHtml(msg.content);

      // Source pills for bot messages
      let sourcesHtml = '';
      if (isBot && msg.sources && msg.sources.length > 0) {
        sourcesHtml = '<div class="mage-sources">' +
          msg.sources.map(s =>
            `<a href="${escapeHtml(s.url)}" class="mage-source-pill" target="_blank" rel="noopener noreferrer" onclick="(function(){` +
            `var e=new CustomEvent('mage:link',{detail:{url:'${escapeHtml(s.url)}'}});document.dispatchEvent(e);` +
            `})()">` +
            `<svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>` +
            `${escapeHtml(s.title)}</a>`
          ).join('') +
          '</div>';
      }

      div.innerHTML = `
        ${isBot ? createBotAvatar() : createUserAvatar()}
        <div class="mage-msg-bubble">${bubbleContent}${sourcesHtml}</div>
      `;
      container.appendChild(div);
    });

    scrollToBottom();
  }

  /* ─── TYPING INDICATOR ──────────────────────────────────────── */
  function showTyping() {
    const container = $('mage-messages');
    if (!container) return;
    // Remove existing if any
    hideTyping();
    const div = document.createElement('div');
    div.className = 'mage-typing mage-msg-enter';
    div.id = 'mage-typing-indicator';
    div.innerHTML = `
      ${createBotAvatar()}
      <div class="mage-typing-dots">
        <span class="mage-typing-dot"></span>
        <span class="mage-typing-dot"></span>
        <span class="mage-typing-dot"></span>
      </div>
    `;
    container.appendChild(div);
    scrollToBottom();
  }

  function hideTyping() {
    const el = $('mage-typing-indicator');
    if (el) el.remove();
  }

  /* ─── LEAD CAPTURE FORM (Section 7) ─────────────────────────── */
  function shouldShowLeadForm() {
    return CONFIG.leadCapture.enabled &&
           !leadCaptured &&
           !leadFormShown &&
           userMsgCount >= CONFIG.leadCapture.triggerAfterMessages;
  }

  function showLeadForm() {
    leadFormShown = true;
    saveState();

    const container = $('mage-messages');
    if (!container) return;

    const formDiv = document.createElement('div');
    formDiv.className = 'mage-lead-form mage-msg-enter';
    formDiv.id = 'mage-lead-form';
    formDiv.innerHTML = `
      <div class="mage-lead-form-title">Before we continue, may I get your details?</div>
      <input type="text" id="mage-lead-name" class="mage-lead-field" placeholder="Name (optional)" aria-label="Your name">
      <input type="email" id="mage-lead-email" class="mage-lead-field" placeholder="Email (required)" aria-label="Your email" required>
      <input type="text" id="mage-lead-company" class="mage-lead-field" placeholder="Company (optional)" aria-label="Your company">
      <button type="button" id="mage-lead-btn" class="mage-lead-submit">Continue chatting</button>
      <button type="button" id="mage-lead-skip-btn" class="mage-lead-skip">Skip for now</button>
    `;
    container.appendChild(formDiv);
    scrollToBottom();

    // Focus the email field
    setTimeout(() => {
      const emailField = $('mage-lead-email');
      if (emailField) emailField.focus();
    }, 350);

    // Submit handler
    $('mage-lead-btn').addEventListener('click', submitLeadForm);
    $('mage-lead-skip-btn').addEventListener('click', skipLeadForm);

    // Enter key in fields
    formDiv.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); submitLeadForm(); }
    });
  }

  async function submitLeadForm() {
    const email = ($('mage-lead-email') || {}).value?.trim();
    const name = ($('mage-lead-name') || {}).value?.trim();
    const company = ($('mage-lead-company') || {}).value?.trim();

    if (!email || !email.includes('@')) {
      const emailField = $('mage-lead-email');
      if (emailField) {
        emailField.style.borderColor = '#EF4444';
        emailField.focus();
        setTimeout(() => { emailField.style.borderColor = ''; }, 2000);
      }
      return;
    }

    leadCaptured = true;
    saveState();

    // Remove the form
    const form = $('mage-lead-form');
    if (form) form.remove();

    // Add a thank you message
    messages.push({ role: 'assistant', content: "Thanks! I've noted your details. Let's continue — how can I help?" });
    renderMessages();
    announce("Thank you. Details captured.");

    // Track GA4 event (Section 8)
    trackEvent('chatbot_lead_capture', { event_label: 'email_collected' });

    // Fire GA4 event via gtag directly too
    if (typeof window.gtag === 'function') {
      try {
        const consent = localStorage.getItem('magedata_consent');
        if (consent && JSON.parse(consent).analytics_storage === 'granted') {
          window.gtag('event', 'chatbot_lead_capture', {
            event_category: 'chatbot',
            event_label: 'email_collected',
          });
        }
      } catch(e) {}
    }

    // Submit to HubSpot (Section 7-2)
    if (CONFIG.leadCapture.hubspotPortalId && CONFIG.leadCapture.hubspotFormId) {
      try {
        const hsUrl = `https://api.hsforms.com/submissions/v3/integration/submit/${CONFIG.leadCapture.hubspotPortalId}/${CONFIG.leadCapture.hubspotFormId}`;
        await fetch(hsUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            fields: [
              { name: 'email', value: email },
              { name: 'firstname', value: name },
              { name: 'company', value: company },
              { name: 'lead_source', value: 'Chatbot' },
            ],
            context: { pageUri: window.location.href, pageName: document.title },
          }),
        });
      } catch(e) {
        console.warn('[MageChat] HubSpot submission failed:', e);
      }
    }

    // Also submit to our backend lead endpoint
    try {
      const backendUrl = CONFIG.apiEndpoint.replace('/chat', '/lead');
      await fetch(backendUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email, firstname: name, company, sessionId }),
      });
    } catch(e) { /* optional, ignore */ }
  }

  function skipLeadForm() {
    leadCaptured = true; // don't ask again this session
    saveState();
    const form = $('mage-lead-form');
    if (form) form.remove();
    // Re-enable input
    const input = $('mage-input');
    if (input) input.focus();
  }

  /* ─── SEND MESSAGE ──────────────────────────────────────────── */
  async function sendMessage(text) {
    text = text.trim();
    if (!text || isLoading) return;

    // Hide chips after first message
    chipsVisible = false;

    // Add user message
    messages.push({ role: 'user', content: text });
    userMsgCount++;
    renderMessages();
    saveState();

    // Track analytics
    trackEvent('chatbot_message_sent', { event_label: text.substring(0, 50) });

    // Clear input
    const input = $('mage-input');
    if (input) input.value = '';

    // Check if we need to show lead form
    if (shouldShowLeadForm()) {
      showLeadForm();
      return;
    }

    // Show typing indicator
    isLoading = true;
    updateSendButton();
    showTyping();

    try {
      const response = await fetch(CONFIG.apiEndpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          messages: messages.map(m => ({ role: m.role, content: m.content })),
          sessionId: sessionId,
        }),
      });

      hideTyping();

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const data = await response.json();

      messages.push({
        role: 'assistant',
        content: data.reply || CONFIG.ui.errorMessage,
        sources: data.sources || [],
      });

      announce(data.reply ? 'New response from Mage Data Assistant' : '');

    } catch(err) {
      console.error('[MageChat] API error:', err);
      hideTyping();
      messages.push({
        role: 'assistant',
        content: CONFIG.ui.errorMessage,
        sources: [],
      });
      announce('Error: could not get a response');
    }

    isLoading = false;
    updateSendButton();
    renderMessages();
    saveState();

    // Check again after bot response
    if (shouldShowLeadForm()) {
      setTimeout(showLeadForm, 600);
    }
  }

  function updateSendButton() {
    const btn = $('mage-send');
    if (btn) btn.disabled = isLoading;
  }

  /* ─── OPEN / CLOSE PANEL ────────────────────────────────────── */
  function openPanel() {
    const panel = $('mage-panel');
    const toggle = $('mage-toggle');
    const iconChat = $('mage-icon-chat');
    const iconClose = $('mage-icon-close');

    if (!panel || !toggle) return;

    isOpen = true;
    panel.style.display = 'flex';
    panel.classList.remove('mage-panel-exit');
    panel.classList.add('mage-panel-enter');

    toggle.setAttribute('aria-expanded', 'true');
    toggle.setAttribute('aria-label', 'Close chat');
    if (iconChat) iconChat.style.display = 'none';
    if (iconClose) iconClose.style.display = 'block';

    // Remove pulse after opening
    toggle.classList.remove('mage-bubble-pulse');

    renderMessages();

    // Focus input
    setTimeout(() => {
      const input = $('mage-input');
      if (input) input.focus();
    }, 300);

    trackEvent('chatbot_opened');
    saveState();
  }

  function closePanel() {
    const panel = $('mage-panel');
    const toggle = $('mage-toggle');
    const iconChat = $('mage-icon-chat');
    const iconClose = $('mage-icon-close');

    if (!panel || !toggle) return;

    isOpen = false;
    panel.classList.remove('mage-panel-enter');
    panel.classList.add('mage-panel-exit');

    toggle.setAttribute('aria-expanded', 'false');
    toggle.setAttribute('aria-label', 'Open chat');
    if (iconChat) iconChat.style.display = 'block';
    if (iconClose) iconClose.style.display = 'none';

    setTimeout(() => {
      panel.style.display = 'none';
      panel.classList.remove('mage-panel-exit');
    }, 200);

    toggle.focus();
    saveState();
  }

  function togglePanel() {
    if (isOpen) closePanel();
    else openPanel();
  }

  /* ─── FOCUS TRAP (Section 3f) ───────────────────────────────── */
  function handleFocusTrap(e) {
    if (!isOpen || e.key !== 'Tab') return;

    const panel = $('mage-panel');
    if (!panel) return;

    const focusable = panel.querySelectorAll(
      'button:not([disabled]), input:not([disabled]), a[href], [tabindex]:not([tabindex="-1"])'
    );
    if (focusable.length === 0) return;

    const first = focusable[0];
    const last = focusable[focusable.length - 1];

    if (e.shiftKey && document.activeElement === first) {
      e.preventDefault();
      last.focus();
    } else if (!e.shiftKey && document.activeElement === last) {
      e.preventDefault();
      first.focus();
    }
  }

  /* ─── KEYBOARD HANDLING ─────────────────────────────────────── */
  function handleKeydown(e) {
    // Escape closes panel (Section 3f)
    if (e.key === 'Escape' && isOpen) {
      e.preventDefault();
      closePanel();
      return;
    }
    handleFocusTrap(e);
  }

  /* ─── LINK CLICK TRACKING ──────────────────────────────────── */
  function handleLinkClick(e) {
    trackEvent('chatbot_link_clicked', { event_label: e.detail?.url || '' });
  }

  /* ─── INITIALIZE ────────────────────────────────────────────── */
  function initChatbot() {
    if (chatbotInitialized) return;
    chatbotInitialized = true;

    restoreState();

    const toggle = $('mage-toggle');
    const closeBtn = $('mage-close');
    const input = $('mage-input');
    const sendBtn = $('mage-send');

    if (toggle) toggle.addEventListener('click', togglePanel);
    if (closeBtn) closeBtn.addEventListener('click', closePanel);

    if (input) {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage(input.value);
        }
      });
    }

    if (sendBtn) {
      sendBtn.addEventListener('click', () => {
        sendMessage(($('mage-input') || {}).value || '');
      });
    }

    document.addEventListener('keydown', handleKeydown);
    document.addEventListener('mage:link', handleLinkClick);

    // Cookie consent coexistence (Section 9)
    watchCookieBanner();

    // Restore open state if it was open before navigation
    if (isOpen) {
      openPanel();
    }
  }

  /* ─── DEFERRED LOADING (Section 3c) ─────────────────────────── */
  let loaded = false;
  function loadChatbot() {
    if (loaded) return;
    loaded = true;
    initChatbot();
  }

  // Load after first interaction OR 5s idle
  ['mousemove', 'touchstart', 'scroll', 'keydown'].forEach(function(event) {
    document.addEventListener(event, loadChatbot, { once: true, passive: true });
  });
  setTimeout(loadChatbot, CONFIG.delayMs);

  /* ─── VIEW TRANSITION PERSISTENCE (Section 3d) ──────────────── */
  document.addEventListener('astro:after-swap', function() {
    // Re-initialize after Astro view transition swap
    chatbotInitialized = false;
    loaded = false;
    loadChatbot();
  });

  // Also handle page show (bfcache)
  window.addEventListener('pageshow', function(e) {
    if (e.persisted && !chatbotInitialized) {
      loadChatbot();
    }
  });

})();
</script>
